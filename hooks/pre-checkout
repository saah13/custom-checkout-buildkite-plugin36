#!/bin/sh

parse_plugin_config() {
  if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-}" ]; then
    case "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY" in
      https://*|http://*|git://*|ssh://*)
        ;;
      *)
        echo "Error: Invalid repository URL format" >&2
        exit 1
        ;;
    esac
  fi
}

parse_plugin_config

if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-}" ]; then
  export BUILDKITE_REPO="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY}"
fi

if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH-}" ]; then
  export BUILDKITE_BRANCH="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH}"
elif [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT-}" ]; then
  export BUILDKITE_COMMIT="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT}"
fi

echo "Custom checkout configured:"
echo "Repository: ${BUILDKITE_REPO-<not set>}"
echo "Branch: ${BUILDKITE_BRANCH-<default>}"
echo "Commit: ${BUILDKITE_COMMIT-<default>}"

# Ensure these variables are available to subsequent steps
buildkite-agent env set BUILDKITE_REPO "${BUILDKITE_REPO}"
buildkite-agent env set BUILDKITE_BRANCH "${BUILDKITE_BRANCH}"
buildkite-agent env set BUILDKITE_COMMIT "${BUILDKITE_COMMIT}"
