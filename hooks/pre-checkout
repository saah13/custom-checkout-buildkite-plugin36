#!/bin/bash

set -euo pipefail

echo "Debug: Starting pre-checkout hook"

echo "Debug: BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-<not set>}"
echo "Debug: BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH-<not set>}"
echo "Debug: BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT-<not set>}"
echo "Debug: BUILDKITE_REPO before=${BUILDKITE_REPO-<not set>}"

parse_plugin_config() {
  if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-}" ]; then
    case "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY" in
      https://*|http://*|git://*|ssh://*)
        ;;
      *)
        echo "Error: Invalid repository URL format" >&2
        exit 1
        ;;
    esac
  fi
}

parse_plugin_config

export BUILDKITE_REPO="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-${BUILDKITE_REPO-}}"
export BUILDKITE_BRANCH="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH-${BUILDKITE_BRANCH-}}"
export BUILDKITE_COMMIT="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT-${BUILDKITE_COMMIT-}}"

echo "Debug: BUILDKITE_REPO after=${BUILDKITE_REPO-<not set>}"

echo "Custom checkout configured:"
echo "Repository: ${BUILDKITE_REPO:-<not set>}"
echo "Branch: ${BUILDKITE_BRANCH:-<not set>}"
echo "Commit: ${BUILDKITE_COMMIT:-<not set>}"

echo "Debug: Ending pre-checkout hook"
