#!/bin/bash

set -euo pipefail

echo "Debug: Starting pre-checkout hook"

# Parse plugin configuration
parse_plugin_config() {
  if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-}" ]; then
    case "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY" in
      https://*|http://*|git://*|ssh://*)
        ;;
      *)
        echo "Error: Invalid repository URL format" >&2
        exit 1
        ;;
    esac
  fi
}

parse_plugin_config

echo "Debug: Plugin configuration:"
echo "BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-<not set>}"
echo "BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH-<not set>}"
echo "BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT=${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT-<not set>}"

# Override BUILDKITE_REPO if custom repository is provided
if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY-}" ]; then
  export BUILDKITE_REPO="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_REPOSITORY}"
fi

# Set custom branch or commit if provided
if [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH-}" ]; then
  export BUILDKITE_BRANCH="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BRANCH}"
elif [ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT-}" ]; then
  export BUILDKITE_COMMIT="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_COMMIT}"
fi

# Log the final configuration
echo "Custom checkout configured:"
echo "Repository: ${BUILDKITE_REPO-<not set>}"
echo "Branch: ${BUILDKITE_BRANCH-<default>}"
echo "Commit: ${BUILDKITE_COMMIT-<default>}"

# Perform the actual checkout
if [ -d ".git" ]; then
  echo "Debug: Git repository already exists, updating instead of cloning"
  git remote set-url origin "${BUILDKITE_REPO}"
  git fetch origin
else
  echo "Debug: Directory not empty, cleaning and cloning repository"
  rm -rf ./* ./.[!.]*
  git clone "${BUILDKITE_REPO}" .
fi

if [ -n "${BUILDKITE_BRANCH-}" ]; then
  echo "Debug: Checking out branch ${BUILDKITE_BRANCH}"
  git checkout -B "${BUILDKITE_BRANCH}" "origin/${BUILDKITE_BRANCH}"
elif [ -n "${BUILDKITE_COMMIT-}" ]; then
  echo "Debug: Checking out commit ${BUILDKITE_COMMIT}"
  git checkout "${BUILDKITE_COMMIT}"
fi

echo "Debug: Ending pre-checkout hook"
