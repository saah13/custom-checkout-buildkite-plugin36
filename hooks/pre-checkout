#!/bin/bash

set -euo pipefail

echo "Debug: Starting pre-checkout hook"

# Read plugin configuration from JSON file
if [ -f "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BUILDKITE_PLUGIN7_CONFIG_PATH" ]; then
    echo "Debug: Reading config from $BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BUILDKITE_PLUGIN7_CONFIG_PATH"
    CUSTOM_REPO=$(jq -r '.repository // empty' "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BUILDKITE_PLUGIN7_CONFIG_PATH")
    CUSTOM_BRANCH=$(jq -r '.branch // empty' "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BUILDKITE_PLUGIN7_CONFIG_PATH")
    CUSTOM_COMMIT=$(jq -r '.commit // empty' "$BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_BUILDKITE_PLUGIN7_CONFIG_PATH")
else
    echo "Debug: Config file not found"
fi

# Set variables, defaulting to current BUILDKITE_* values if not set
CUSTOM_REPO="${CUSTOM_REPO:-$BUILDKITE_REPO}"
CUSTOM_BRANCH="${CUSTOM_BRANCH:-$BUILDKITE_BRANCH}"
CUSTOM_COMMIT="${CUSTOM_COMMIT:-$BUILDKITE_COMMIT}"

echo "Custom checkout configured:"
echo "Repository: ${CUSTOM_REPO}"
echo "Branch: ${CUSTOM_BRANCH}"
echo "Commit: ${CUSTOM_COMMIT}"

# Export for use in subsequent steps
export BUILDKITE_REPO="$CUSTOM_REPO"
export BUILDKITE_BRANCH="$CUSTOM_BRANCH"
export BUILDKITE_COMMIT="$CUSTOM_COMMIT"

echo "Debug: Ending pre-checkout hook"
