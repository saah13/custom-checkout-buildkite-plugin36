#!/bin/bash

set -euo pipefail

# Function to log messages
log() {
  echo "~~~ $1"
}

# Function to handle errors
error() {
  echo "ðŸš¨ Error: $1" >&2
  exit 1
}

# Function to log debug information
debug() {
  echo "Debug: $1"
}

# Parse plugin configuration
parse_config() {
  SKIP_CHECKOUT="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT23_SKIP_CHECKOUT:-false}"
  debug "SKIP_CHECKOUT value: $SKIP_CHECKOUT"
  
  if [[ "$SKIP_CHECKOUT" != "true" ]]; then
    log "Warning: The 'skip_checkout' option is not set to true. This may cause conflicts with Buildkite's default checkout."
  fi

  CUSTOM_CHECKOUT_PATH="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT23_BUILD_CHECKOUT_PATH:-$BUILDKITE_BUILD_CHECKOUT_PATH}"
  DELETE_CHECKOUT="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT23_DELETE_CHECKOUT:-false}"
  
  # Parse custom repository configuration
  CUSTOM_REPO="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT23_REPOS_0_CONFIG_0_URL:-$BUILDKITE_REPO}"
  CUSTOM_REF="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT23_REPOS_0_CONFIG_0_REF:-$BUILDKITE_BRANCH}"
  
  debug "CUSTOM_REPO: $CUSTOM_REPO"
  debug "CUSTOM_REF: $CUSTOM_REF"
  debug "CUSTOM_CHECKOUT_PATH: $CUSTOM_CHECKOUT_PATH"
}

# Perform git checkout
git_checkout() {
  local url="$1"
  local ref="${2:-}"

  if [[ -d ".git" ]]; then
    log "Updating existing repository"
    git remote set-url origin "$url" || error "Failed to set remote URL"
    git fetch origin || error "Failed to fetch from remote"
  else
    log "Cloning repository"
    git clone "$url" . || error "Failed to clone repository"
  fi

  if [[ -n "$ref" ]]; then
    log "Checking out ref: $ref"
    git checkout -B "$ref" "origin/$ref" || error "Failed to checkout ref"
  else
    log "Checking out default branch"
    git checkout -B "${BUILDKITE_BRANCH}" "origin/${BUILDKITE_BRANCH}" || error "Failed to checkout branch"
  fi
}

# Main execution
parse_config

log "Custom checkout configured:"
log "Repository: ${CUSTOM_REPO}"
log "Ref: ${CUSTOM_REF}"
log "Checkout path: ${CUSTOM_CHECKOUT_PATH}"

mkdir -p "$CUSTOM_CHECKOUT_PATH"
cd "$CUSTOM_CHECKOUT_PATH"

git_checkout "$CUSTOM_REPO" "$CUSTOM_REF"

# Set Buildkite environment variables
export BUILDKITE_REPO="$CUSTOM_REPO"
export BUILDKITE_REFSPEC="$CUSTOM_REF"
export BUILDKITE_COMMIT="$(git rev-parse HEAD)"
export BUILDKITE_BUILD_CHECKOUT_PATH="$CUSTOM_CHECKOUT_PATH"

log "Custom checkout completed successfully"
log "Current commit: $BUILDKITE_COMMIT"
log "Commit message: $(git log -1 --pretty=%B)"
log "Commit author: $(git log -1 --pretty=%an)"
log "Commit date: $(git log -1 --pretty=%ad)"

if [[ "$DELETE_CHECKOUT" == "true" ]]; then
  trap 'rm -rf "$CUSTOM_CHECKOUT_PATH"' EXIT
fi
